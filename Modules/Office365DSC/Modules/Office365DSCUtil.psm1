$Locales = @(
    @{
        EnglishName = "Arabic (Algeria)"
        ID          = "5121"
    },
    @{
        EnglishName = "Arabic (Bahrain)"
        ID          = "15361"
    },
    @{
        EnglishName = "Arabic (Egypt)"
        ID          = "3073"
    },
    @{
        EnglishName = "Arabic (Iraq)"
        ID          = "2049"
    },
    @{
        EnglishName = "Arabic (Jordan)"
        ID          = "11265"
    },
    @{
        EnglishName = "Arabic (Kuwait)"
        ID          = "13313"
    },
    @{
        EnglishName = "Arabic (Lebanon)"
        ID          = "12289"
    },
    @{
        EnglishName = "Arabic (Libya)"
        ID          = "4097"
    },
    @{
        EnglishName = "Arabic (Morocco)"
        ID          = "6145"
    },
    @{
        EnglishName = "Arabic (Oman)"
        ID          = "8193"
    },
    @{
        EnglishName = "Arabic (Qatar)"
        ID          = "16385"
    },
    @{
        EnglishName = "Arabic (Saudi Arabia)"
        ID          = "1025"
    },
    @{
        EnglishName = "Arabic (Syria)"
        ID          = "10241"
    },
    @{
        EnglishName = "Arabic (Tunisia)"
        ID          = "7169"
    },
    @{
        EnglishName = "Arabic (U.A.E.)"
        ID          = "14337"
    },
    @{
        EnglishName = "Arabic (Yemen)"
        ID          = "9217"
    },
    @{
        EnglishName = "Basque"
        ID          = "1069"
    },
    @{
        EnglishName = "Bulgarian"
        ID          = "1026"
    },
    @{
        EnglishName = "Catalan"
        ID          = "1027"
    },
    @{
        EnglishName = "Chinese (Hong Kong S.A.R)"
        ID          = "3076"
    },
    @{
        EnglishName = "Chinese (Macau S.A.R)"
        ID          = "5124"
    },
    @{
        EnglishName = "Chinese (People's Republic of China)"
        ID          = "2052"
    },
    @{
        EnglishName = "Chinese (Singapore)"
        ID          = "4100"
    },
    @{
        EnglishName = "Chinese (Taiwan)"
        ID          = "1028"
    },
    @{
        EnglishName = "Croatian"
        ID          = "1050"
    },
    @{
        EnglishName = "Czech"
        ID          = "1029"
    },
    @{
        EnglishName = "Danish"
        ID          = "1030"
    },
    @{
        EnglishName = "Dutch (Belgium)"
        ID          = "2067"
    },
    @{
        EnglishName = "Dutch (Netherlands)"
        ID          = "1043"
    },
    @{
        EnglishName = "English (Australia)"
        ID          = "3081"
    },
    @{
        EnglishName = "English (Belize)"
        ID          = "10249"
    },
    @{
        EnglishName = "English (Canada)"
        ID          = "4105"
    },
    @{
        EnglishName = "English (Caribbean)"
        ID          = "9225"
    },
    @{
        EnglishName = "English (Ireland)"
        ID          = "6153"
    },
    @{
        EnglishName = "English (Jamaica)"
        ID          = "8201"
    },
    @{
        EnglishName = "English (New Zealand)"
        ID          = "5129"
    },
    @{
        EnglishName = "English (Republic of the Philippines)"
        ID          = "13321"
    },
    @{
        EnglishName = "English (South Africa)"
        ID          = "7177"
    },
    @{
        EnglishName = "English (Trinidad)"
        ID          = "11273"
    },
    @{
        EnglishName = "English (United Kingdom)"
        ID          = "2057"
    },
    @{
        EnglishName = "English (United States)"
        ID          = "1033"
    },
    @{
        EnglishName = "English (Zimbabwe)"
        ID          = "12297"
    },
    @{
        EnglishName = "Estonian"
        ID          = "1061"
    },
    @{
        EnglishName = "Filipino (Philippines)"
        ID          = "1124"
    },
    @{
        EnglishName = "Finnish"
        ID          = "1035"
    },
    @{
        EnglishName = "French (Belgium)"
        ID          = "2060"
    },
    @{
        EnglishName = "French (Canada)"
        ID          = "3084"
    },
    @{
        EnglishName = "French (France)"
        ID          = "1036"
    },
    @{
        EnglishName = "French (Luxembourg)"
        ID          = "5132"
    },
    @{
        EnglishName = "French (Principality of Monaco)"
        ID          = "6156"
    },
    @{
        EnglishName = "French (Switzerland)"
        ID          = "4108"
    },
    @{
        EnglishName = "German (Austria)"
        ID          = "3079"
    },
    @{
        EnglishName = "German (Germany)"
        ID          = "1031"
    },
    @{
        EnglishName = "German (Liechtenstein)"
        ID          = "5127"
    },
    @{
        EnglishName = "German (Luxembourg)"
        ID          = "4103"
    },
    @{
        EnglishName = "German (Switzerland)"
        ID          = "2055"
    },
    @{
        EnglishName = "Greek"
        ID          = "1032"
    },
    @{
        EnglishName = "Hebrew"
        ID          = "1037"
    },
    @{
        EnglishName = "Hindi"
        ID          = "1081"
    },
    @{
        EnglishName = "Hungarian"
        ID          = "1038"
    },
    @{
        EnglishName = "Icelandic"
        ID          = "1039"
    },
    @{
        EnglishName = "Indonesian"
        ID          = "1057"
    },
    @{
        EnglishName = "Italian (Italy)"
        ID          = "1040"
    },
    @{
        EnglishName = "Italian (Switzerland)"
        ID          = "2064"
    },
    @{
        EnglishName = "Japanese"
        ID          = "1041"
    },
    @{
        EnglishName = "Kazakh"
        ID          = "1087"
    },
    @{
        EnglishName = "Korean"
        ID          = "1042"
    },
    @{
        EnglishName = "Latvian"
        ID          = "1062"
    },
    @{
        EnglishName = "Lithuanian"
        ID          = "1063"
    },
    @{
        EnglishName = "Malay"
        ID          = "1086"
    },
    @{
        EnglishName = "Norwegian (Bokmal)"
        ID          = "1044"
    },
    @{
        EnglishName = "Persian"
        ID          = "1065"
    },
    @{
        EnglishName = "Polish"
        ID          = "1045"
    },
    @{
        EnglishName = "Portuguese (Brazil)"
        ID          = "1046"
    },
    @{
        EnglishName = "Portuguese (Portugal)"
        ID          = "2070"
    },
    @{
        EnglishName = "Romanian"
        ID          = "1048"
    },
    @{
        EnglishName = "Russian"
        ID          = "1049"
    },
    @{
        EnglishName = "Serbian (Cyrillic)"
        ID          = "3098"
    },
    @{
        EnglishName = "Serbian (Latin)"
        ID          = "2074"
    },
    @{
        EnglishName = "Slovak"
        ID          = "1051"
    },
    @{
        EnglishName = "Slovenian"
        ID          = "1060"
    },
    @{
        EnglishName = "Spanish (Argentina)"
        ID          = "11274"
    },
    @{
        EnglishName = "Spanish (Bolivia)"
        ID          = "16394"
    },
    @{
        EnglishName = "Spanish (Chile)"
        ID          = "13322"
    },
    @{
        EnglishName = "Spanish (Colombia)"
        ID          = "9226"
    },
    @{
        EnglishName = "Spanish (Costa Rica)"
        ID          = "5130"
    },
    @{
        EnglishName = "Spanish (Dominican Republic)"
        ID          = "7178"
    },
    @{
        EnglishName = "Spanish (Ecuador)"
        ID          = "12298"
    },
    @{
        EnglishName = "Spanish (El Salvador)"
        ID          = "17418"
    },
    @{
        EnglishName = "Spanish (Guatemala)"
        ID          = "4106"
    },
    @{
        EnglishName = "Spanish (Honduras)"
        ID          = "18442"
    },
    @{
        EnglishName = "Spanish (Mexico)"
        ID          = "2058"
    },
    @{
        EnglishName = "Spanish (Nicaragua)"
        ID          = "19466"
    },
    @{
        EnglishName = "Spanish (Panama)"
        ID          = "6154"
    },
    @{
        EnglishName = "Spanish (Paraguay)"
        ID          = "15370"
    },
    @{
        EnglishName = "Spanish (Peru)"
        ID          = "10250"
    },
    @{
        EnglishName = "Spanish (Puerto Rico)"
        ID          = "20490"
    },
    @{
        EnglishName = "Spanish (International Sort)"
        ID          = "3082"
    },
    @{
        EnglishName = "Spanish (Traditional Sort)"
        ID          = "1034"
    },
    @{
        EnglishName = "Spanish (Uruguay)"
        ID          = "14346"
    },
    @{
        EnglishName = "Spanish (Venezuela)"
        ID          = "8202"
    },
    @{
        EnglishName = "Swedish (Finland)"
        ID          = "2077"
    },
    @{
        EnglishName = "Swedish (Sweden)"
        ID          = "1053"
    },
    @{
        EnglishName = "Thai"
        ID          = "1054"
    },
    @{
        EnglishName = "Turkish"
        ID          = "1055"
    },
    @{
        EnglishName = "Ukrainian"
        ID          = "1058"
    },
    @{
        EnglishName = "Urdu"
        ID          = "1056"
    },
    @{
        EnglishName = "Vietnamese"
        ID          = "1066"
    }
)

$TimeZones = @(
    @{
        ID                 = "000"
        EnglishName        = "Dateline Standard Time"
        EnglishDescription = "(GMT-12:00) International Date Line West"
    },
    @{
        ID                 = "001"
        EnglishName        = "Samoa Standard Time"
        EnglishDescription = "(GMT-11:00) Midway Island, Samoa"
    },
    @{
        ID                 = "002"
        EnglishName        = "Hawaiian Standard Time"
        EnglishDescription = "(GMT-10:00) Hawaii"
    },
    @{
        ID                 = "003"
        EnglishName        = "Alaskan Standard Time"
        EnglishDescription = "(GMT-09:00) Alaska"
    },
    @{
        ID                 = "004"
        EnglishName        = "Pacific Standard Time"
        EnglishDescription = "(GMT-08:00) Pacific Time (US and Canada); Tijuana"
    },
    @{
        ID                 = "010"
        EnglishName        = "Mountain Standard Time"
        EnglishDescription = "(GMT-07:00) Mountain Time (US and Canada)"
    },
    @{
        ID                 = "013"
        EnglishName        = "Mexico Standard Time 2"
        EnglishDescription = "(GMT-07:00) Chihuahua, La Paz, Mazatlan"
    },
    @{
        ID                 = "015"
        EnglishName        = "U.S. Mountain Standard Time"
        EnglishDescription = "(GMT-07:00) Arizona"
    },
    @{
        ID                 = "020"
        EnglishName        = "Central Standard Time"
        EnglishDescription = "(GMT-06:00) Central Time (US and Canada"
    },
    @{
        ID                 = "025"
        EnglishName        = "Canada Central Standard Time"
        EnglishDescription = "(GMT-06:00) Saskatchewan"
    },
    @{
        ID                 = "030"
        EnglishName        = "Mexico Standard Time"
        EnglishDescription = "(GMT-06:00) Guadalajara, Mexico City, Monterrey"
    },
    @{
        ID                 = "033"
        EnglishName        = "Central America Standard Time"
        EnglishDescription = "(GMT-06:00) Central America"
    },
    @{
        ID                 = "035"
        EnglishName        = "Eastern Standard Time"
        EnglishDescription = "(GMT-05:00) Eastern Time (US and Canada)"
    },
    @{
        ID                 = "040"
        EnglishName        = "U.S. Eastern Standard Time"
        EnglishDescription = "(GMT-05:00) Indiana (East)"
    },
    @{
        ID                 = "045"
        EnglishName        = "S.A. Pacific Standard Time"
        EnglishDescription = "(GMT-05:00) Bogota, Lima, Quito"
    },
    @{
        ID                 = "050"
        EnglishName        = "Atlantic Standard Time"
        EnglishDescription = "(GMT-04:00) Atlantic Time (Canada)"
    },
    @{
        ID                 = "055"
        EnglishName        = "S.A. Western Standard Time"
        EnglishDescription = "(GMT-04:00) Caracas, La Paz"
    },
    @{
        ID                 = "056"
        EnglishName        = "Pacific S.A. Standard Time"
        EnglishDescription = "(GMT-04:00) Santiago"
    },
    @{
        ID                 = "060"
        EnglishName        = "Newfoundland and Labrador Standard Time"
        EnglishDescription = "(GMT-03:30) Newfoundland and Labrador"
    },
    @{
        ID                 = "065"
        EnglishName        = "E. South America Standard Time"
        EnglishDescription = "(GMT-03:00) Brasilia"
    },
    @{
        ID                 = "070"
        EnglishName        = "S.A. Eastern Standard Time"
        EnglishDescription = "(GMT-03:00) Buenos Aires, Georgetown"
    },
    @{
        ID                 = "073"
        EnglishName        = "Greenland Standard Time"
        EnglishDescription = "(GMT-03:00) Greenland"
    },
    @{
        ID                 = "075"
        EnglishName        = "Mid-Atlantic Standard Time"
        EnglishDescription = "(GMT-02:00) Mid-Atlantic"
    },
    @{
        ID                 = "080"
        EnglishName        = "Azores Standard Time"
        EnglishDescription = "(GMT-01:00) Azores"
    },
    @{
        ID                 = "083"
        EnglishName        = "Cape Verde Standard Time"
        EnglishDescription = "(GMT-01:00) Cape Verde Islands"
    },
    @{
        ID                 = "085"
        EnglishName        = "GMT Standard Time"
        EnglishDescription = "(GMT) Greenwich Mean Time: Dublin, Edinburgh, Lisbon, London"
    },
    @{
        ID                 = "090"
        EnglishName        = "Greenwich Standard Time"
        EnglishDescription = "(GMT) Casablanca, Monrovia"
    },
    @{
        ID                 = "095"
        EnglishName        = "Central Europe Standard Time"
        EnglishDescription = "(GMT+01:00) Belgrade, Bratislava, Budapest, Ljubljana, Prague"
    },
    @{
        ID                 = "100"
        EnglishName        = "Central European Standard Time"
        EnglishDescription = "(GMT+01:00) Sarajevo, Skopje, Warsaw, Zagreb"
    },
    @{
        ID                 = "105"
        EnglishName        = "Romance Standard Time"
        EnglishDescription = "(GMT+01:00) Brussels, Copenhagen, Madrid, Paris"
    },
    @{
        ID                 = "110"
        EnglishName        = "W. Europe Standard Time"
        EnglishDescription = "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna"
    },
    @{
        ID                 = "113"
        EnglishName        = "W. Central Africa Standard Time"
        EnglishDescription = "(GMT+01:00) West Central Africa"
    },
    @{
        ID                 = "115"
        EnglishName        = "E. Europe Standard Time"
        EnglishDescription = "(GMT+02:00) Bucharest"
    },
    @{
        ID                 = "120"
        EnglishName        = "Egypt Standard Time"
        EnglishDescription = "(GMT+02:00) Cairo"
    },
    @{
        ID                 = "125"
        EnglishName        = "FLE Standard Time"
        EnglishDescription = "(GMT+02:00) Helsinki, Kiev, Riga, Sofia, Tallinn, Vilnius"
    },
    @{
        ID                 = "130"
        EnglishName        = "GTB Standard Time"
        EnglishDescription = "(GMT+02:00) Athens, Istanbul, Minsk"
    },
    @{
        ID                 = "135"
        EnglishName        = "Israel Standard Time"
        EnglishDescription = "(GMT+02:00) Jerusalem"
    },
    @{
        ID                 = "140"
        EnglishName        = "South Africa Standard Time"
        EnglishDescription = "(GMT+02:00) Harare, Pretoria"
    },
    @{
        ID                 = "145"
        EnglishName        = "Russian Standard Time"
        EnglishDescription = "(GMT+03:00) Moscow, St. Petersburg, Volgograd"
    },
    @{
        ID                 = "150"
        EnglishName        = "Arab Standard Time"
        EnglishDescription = "(GMT+03:00) Kuwait, Riyadh"
    },
    @{
        ID                 = "155"
        EnglishName        = "E. Africa Standard Time"
        EnglishDescription = "(GMT+03:00) Nairobi"
    },
    @{
        ID                 = "158"
        EnglishName        = "Arabic Standard Time"
        EnglishDescription = "(GMT+03:00) Baghdad"
    },
    @{
        ID                 = "160"
        EnglishName        = "Iran Standard Time"
        EnglishDescription = "(GMT+03:30) Tehran"
    },
    @{
        ID                 = "165"
        EnglishName        = "Arabian Standard Time"
        EnglishDescription = "(GMT+04:00) Abu Dhabi, Muscat"
    },
    @{
        ID                 = "170"
        EnglishName        = "Caucasus Standard Time"
        EnglishDescription = "(GMT+04:00) Baku, Tbilisi, Yerevan"
    },
    @{
        ID                 = "175"
        EnglishName        = "Transitional Islamic State of Afghanistan Standard Time"
        EnglishDescription = "(GMT+04:30) Kabul"
    },
    @{
        ID                 = "180"
        EnglishName        = "Ekaterinburg Standard Time"
        EnglishDescription = "(GMT+05:00) Ekaterinburg"
    },
    @{
        ID                 = "185"
        EnglishName        = "West Asia Standard Time"
        EnglishDescription = "(GMT+05:00) Islamabad, Karachi, Tashkent"
    },
    @{
        ID                 = "190"
        EnglishName        = "India Standard Time"
        EnglishDescription = "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi"
    },
    @{
        ID                 = "193"
        EnglishName        = "Nepal Standard Time"
        EnglishDescription = "(GMT+05:45) Kathmandu"
    },
    @{
        ID                 = "195"
        EnglishName        = "Central Asia Standard Time"
        EnglishDescription = "(GMT+06:00) Astana, Dhaka"
    },
    @{
        ID                 = "200"
        EnglishName        = "Sri Lanka Standard Time"
        EnglishDescription = "(GMT+06:00) Sri Jayawardenepura"
    },
    @{
        ID                 = "201"
        EnglishName        = "N. Central Asia Standard Time"
        EnglishDescription = "(GMT+06:00) Almaty, Novosibirsk"
    },
    @{
        ID                 = "203"
        EnglishName        = "Myanmar Standard Time"
        EnglishDescription = "(GMT+06:30) Yangon Rangoon"
    },
    @{
        ID                 = "205"
        EnglishName        = "S.E. Asia Standard Time"
        EnglishDescription = "(GMT+07:00) Bangkok, Hanoi, Jakarta"
    },
    @{
        ID                 = "207"
        EnglishName        = "North Asia Standard Time"
        EnglishDescription = "(GMT+07:00) Krasnoyarsk"
    },
    @{
        ID                 = "210"
        EnglishName        = "China Standard Time"
        EnglishDescription = "(GMT+08:00) Beijing, Chongqing, Hong Kong SAR, Urumqi"
    },
    @{
        ID                 = "215"
        EnglishName        = "Singapore Standard Time"
        EnglishDescription = "(GMT+08:00) Kuala Lumpur, Singapore"
    },
    @{
        ID                 = "220"
        EnglishName        = "Taipei Standard Time"
        EnglishDescription = "(GMT+08:00) Taipei"
    },
    @{
        ID                 = "225"
        EnglishName        = "W. Australia Standard Time"
        EnglishDescription = "(GMT+08:00) Perth"
    },
    @{
        ID                 = "227"
        EnglishName        = "North Asia East Standard Time"
        EnglishDescription = "(GMT+08:00) Irkutsk, Ulaanbaatar"
    },
    @{
        ID                 = "230"
        EnglishName        = "Korea Standard Time"
        EnglishDescription = "(GMT+09:00) Seoul"
    },
    @{
        ID                 = "235"
        EnglishName        = "Tokyo Standard Time"
        EnglishDescription = "(GMT+09:00) Osaka, Sapporo, Tokyo"
    },
    @{
        ID                 = "240"
        EnglishName        = "Yakutsk Standard Time"
        EnglishDescription = "(GMT+09:00) Yakutsk"
    },
    @{
        ID                 = "245"
        EnglishName        = "A.U.S. Central Standard Time"
        EnglishDescription = "(GMT+09:30) Darwin"
    },
    @{
        ID                 = "250"
        EnglishName        = "Cen. Australia Standard Time"
        EnglishDescription = "(GMT+09:30) Adelaide"
    },
    @{
        ID                 = "255"
        EnglishName        = "A.U.S. Eastern Standard Time"
        EnglishDescription = "(GMT+10:00) Canberra, Melbourne, Sydney"
    },
    @{
        ID                 = "260"
        EnglishName        = "E. Australia Standard Time"
        EnglishDescription = "(GMT+10:00) Brisbane"
    },
    @{
        ID                 = "265"
        EnglishName        = "Tasmania Standard Time"
        EnglishDescription = "(GMT+10:00) Hobart"
    },
    @{
        ID                 = "270"
        EnglishName        = "Vladivostok Standard Time"
        EnglishDescription = "(GMT+10:00) Vladivostok"
    },
    @{
        ID                 = "275"
        EnglishName        = "West Pacific Standard Time"
        EnglishDescription = "(GMT+10:00) Guam, Port Moresby"
    },
    @{
        ID                 = "280"
        EnglishName        = "Central Pacific Standard Time"
        EnglishDescription = "(GMT+11:00) Magadan, Solomon Islands, New Caledonia"
    },
    @{
        ID                 = "285"
        EnglishName        = "Fiji Islands Standard Time"
        EnglishDescription = "(GMT+12:00) Fiji Islands, Kamchatka, Marshall Islands"
    },
    @{
        ID                 = "290"
        EnglishName        = "New Zealand Standard Time"
        EnglishDescription = "(GMT+12:00) Auckland, Wellington"
    },
    @{
        ID                 = "300"
        EnglishName        = "Tonga Standard Time"
        EnglishDescription = "(GMT+13:00) Nukuâ€™alofa"
    }
)
function Format-EXOParams
{
    [CmdletBinding()]
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $InputEXOParams,

        [Parameter()]
        [ValidateSet('New', 'Set')]
        [System.String]
        $Operation
    )
    $EXOParams = $InputEXOParams
    $EXOParams.Remove("GlobalAdminAccount") | out-null
    $EXOParams.Remove("Ensure") | out-null
    $EXOParams.Remove("Verbose") | out-null
    if ('New' -eq $Operation)
    {
        $EXOParams += @{
            Name = $EXOParams.Identity
        }
        $EXOParams.Remove("Identity") | out-null
        $EXOParams.Remove("MakeDefault") | out-null
        return $EXOParams
    }
    if ('Set' -eq $Operation)
    {
        $EXOParams.Remove("Enabled") | out-null
        return $EXOParams
    }
}

function Get-LocaleIDFromName
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $Name
    )

    $LocaleObject = $Locales | Where-Object { $_.EnglishName -eq $Name }

    if ($null -eq $LocaleObject)
    {
        throw "The specified Locale name {$($Name)} is not valid"
    }
    return $LocaleObject.ID
}

function Get-LocaleNameFromID
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $ID
    )

    $LocaleObject = $Locales | Where-Object { $_.ID -eq $ID }

    if ($null -eq $LocaleObject)
    {
        throw "The specified Locale with ID {$($ID)} is not valid"
    }
    return $LocaleObject.EnglishName
}

function Get-TimeZoneNameFromID
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $ID
    )

    $TimezoneObject = $Timezones | Where-Object { $_.ID -eq $ID }

    if ($null -eq $TimezoneObject)
    {
        throw "The specified Timzone with ID {$($ID)} is not valid"
    }
    return $TimezoneObject.EnglishName
}
function Get-TimeZoneIDFromName
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $Name
    )

    $TimezoneObject = $Timezones | Where-Object { $_.EnglishName -eq $Name }

    if ($null -eq $TimezoneObject)
    {
        throw "The specified Timzone {$($Name)} is not valid"
    }
    return $TimezoneObject.ID
}

function Get-TeamByGroupID
{
    [CmdletBinding()]
    [OutputType([Boolean])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $GroupId
    )

    $team = Get-Team  |  Where-Object {($_.GroupId -eq $GroupId)}
    if ($null -eq $team)
    {
        return $false
    }
    return $true
}
function Get-TeamByName
{
    [CmdletBinding()]
    [OutputType([Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $TeamName
    )

    $loopCounter = 0
    do
    {
        $team = Get-Team |  Where-Object {$_.DisplayName -eq $TeamName}
        if ($null -eq $team)
        {
            Start-Sleep 5
        }
        $loopCounter +=1
        if ($loopCounter -gt 5)
        {
            break
        }
    } while ($null -eq $team)

    if ($null -eq $team)
    {
        throw "Team with Name $TeamName doesn't exist in tenant"
    }
    return $team
}
function Connect-ExchangeOnline
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "Continue"
    $ClosedOrBrokenSessions = Get-PSSession -ErrorAction SilentlyContinue | Where-Object { $_.State -ne 'Opened' }
    if ($ClosedOrBrokenSessions)
    {
        Write-Verbose "Found Existing Unusable Session(s)."
        foreach ($SessionToBeClosed in $ClosedOrBrokenSessions)
        {
            Write-Verbose "Closing Session: $(($SessionToBeClosed).InstanceId)"
            $SessionToBeClosed | Remove-PSSession
        }
    }

    $Global:OpenExchangeSession = Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Where-Object { $_.State -eq 'Opened' }
    if ($null -eq $Global:OpenExchangeSession)
    {
        try
        {
            $PowerShellConnections = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}

            while ($PowerShellConnections)
            {
                Write-Verbose "This process is using the following connections in a non-Established state: $($PowerShellConnections | Out-String)"
                Write-Verbose "Waiting for closing connections to close..."
                Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Remove-PSSession
                Start-Sleep -seconds 1
                $CheckConnectionsWithoutKillingWhileLoop = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}
                if (-NOT $CheckConnectionsWithoutKillingWhileLoop) {
                    Write-Verbose "Connections have closed.  Waiting 5 more seconds..."
                    Start-Sleep -seconds 5
                    $PowerShellConnections = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}
                }
            }

            if ($Global:ExchangeOnlineSession.State -eq "Closed")
            {
                Remove-PSSession $Global:ExchangeOnlineSession
                $Global:ExchangeOnlineSession = $null
            }

            while ($null -eq $Global:ExchangeOnlineSession)
            {
                Write-Verbose "Creating new EXO Session"
                $Global:ExchangeOnlineSession = New-PSSession -Name 'ExchangeOnline' -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $GlobalAdminAccount -Authentication Basic -AllowRedirection -ErrorAction SilentlyContinue

                if ($null -eq $Global:ExchangeOnlineSession)
                {
                    Write-Warning "Exceeded max number of connections. Waiting 60 seconds"
                    Start-Sleep 60
                }
            }

            if ($null -eq $Global:ExchangeOnlineModules)
            {
                Write-Verbose "Importing all commands into the EXO Session"
                $Global:ExchangeOnlineModules = Import-PSSession $Global:ExchangeOnlineSession -AllowClobber
                Import-Module $Global:ExchangeOnlineModules -Global | Out-Null
            }
        }
        catch
        {
            $ExceptionMessage = $_.Exception
            $Error.Clear()
            $VerbosePreference = 'SilentlyContinue'
            if ($ExceptionMessage -imatch 'Please wait for [0-9]* seconds' )
            {
                Write-Verbose "Waiting for available runspace..."
                [regex]$WaitTimePattern = 'Please wait for [0-9]* seconds'
                $WaitTimePatternMatch = (($WaitTimePattern.Match($ExceptionMessage)).Value | Select-String -Pattern '[0-9]*' -AllMatches )
                $WaitTimeInSeconds = ($WaitTimePatternMatch | ForEach-Object {$_.Matches} | Where-Object Value -NotLike $null).Value
                Write-Verbose "Waiting for requested $WaitTimeInSeconds seconds..."
                Start-Sleep -Seconds ($WaitTimeInSeconds + 1)
                try
                {
                    Write-Verbose "Opening New ExchangeOnline Session."
                    $PowerShellConnections = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}
                    while ($PowerShellConnections)
                    {
                        Write-Verbose "This process is using the following connections in a non-Established state: $($PowerShellConnections | Out-String)"
                        Write-Verbose "Waiting for closing connections to close..."
                        Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Remove-PSSession
                        Start-Sleep -seconds 1
                        $CheckConnectionsWithoutKillingWhileLoop = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}
                        if (-NOT $CheckConnectionsWithoutKillingWhileLoop) {
                            Write-Verbose "Connections have closed.  Waiting 5 more seconds..."
                            Start-Sleep -seconds 5
                            $PowerShellConnections = Get-NetTCPConnection | Where-Object {$_.OwningProcess -eq $PID -and $_.RemotePort -eq '443' -and $_.State -ne 'Established'}
                        }
                    }
                    $VerbosePreference = 'SilentlyContinue'
                    $Global:ExchangeOnlineSession = $null
                    while (-NOT $Global:ExchangeOnlineSession)
                    {
                        $Global:ExchangeOnlineSession = New-PSSession -Name 'ExchangeOnline' -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $GlobalAdminAccount -Authentication Basic -AllowRedirection -ErrorAction SilentlyContinue
                    }

                    $Global:ExchangeOnlineModules = Import-PSSession $Global:ExchangeOnlineSession -AllowClobber -ErrorAction SilentlyContinue

                    $ExchangeOnlineModuleImport = Import-Module $ExchangeOnlineModules -Global -ErrorAction SilentlyContinue
                }
                catch
                {
                    $VerbosePreference = 'SilentlyContinue'
                    $WarningPreference = "SilentlyContinue"
                    $Global:ExchangeOnlineSession = $null
                    Close-SessionsAndReturnError -ExceptionMessage $_.Exception
                }
            }
            else
            {
                Write-Verbose $_.Exception
                $VerbosePreference = 'SilentlyContinue'
                Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Remove-PSSession
                Write-Verbose "Exchange Online connection failed."
                Write-Verbose "Waiting 60 seconds..."
                Start-Sleep -Seconds 60
                try
                {
                    Write-Verbose "Opening New ExchangeOnline Session."
                    $VerbosePreference = 'SilentlyContinue'
                    Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Remove-PSSession -ErrorAction SilentlyContinue
                    $Global:ExchangeOnlineSession = New-PSSession -Name 'ExchangeOnline' -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $GlobalAdminAccount -Authentication Basic -AllowRedirection
                    $Global:ExchangeOnlineModules = Import-PSSession $Global:ExchangeOnlineSession -AllowClobber -ErrorAction SilentlyContinue

                    $ExchangeOnlineModuleImport = Import-Module $ExchangeOnlineModules -Global -ErrorAction SilentlyContinue
                }
                catch
                {
                    $VerbosePreference = 'SilentlyContinue'
                    $WarningPreference = "SilentlyContinue"
                    $Global:ExchangeOnlineSession = $null
                    Close-SessionsAndReturnError -ExceptionMessage $_.Exception
                }
            }
        }
    }
    else
    {
        Write-Verbose "Using Existing ExchangeOnline Session."
        $Global:OpenExchangeSession = Get-PSSession -Name 'ExchangeOnline' -ErrorAction SilentlyContinue | Where-Object { $_.State -eq 'Opened' }
        $VerbosePreference = 'SilentlyContinue'
        $WarningPreference = "SilentlyContinue"
    }
}

function New-EXOAntiPhishPolicy
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $AntiPhishPolicyParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $AntiPhishPolicyParams -Operation 'New' )
        Write-Verbose "Creating New AntiPhishPolicy $($BuiltParams.Name) with values: $($BuiltParams | Out-String)"
        New-AntiPhishPolicy @BuiltParams
        $VerbosePreference = 'SilentlyContinue'
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function New-EXOAntiPhishRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $AntiPhishRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $AntiPhishRuleParams -Operation 'New' )
        Write-Verbose "Creating New AntiPhishRule $($BuiltParams.Name) with values: $($BuiltParams | Out-String)"
        New-AntiPhishRule @BuiltParams -Confirm:$false
        $VerbosePreference = 'SilentlyContinue'
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function New-EXOHostedContentFilterRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $HostedContentFilterRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $HostedContentFilterRuleParams -Operation 'New' )
        Write-Verbose "Creating New HostedContentFilterRule $($BuiltParams.Name) with values: $($BuiltParams | Out-String)"
        New-HostedContentFilterRule @BuiltParams -Confirm:$false
        $VerbosePreference = 'SilentlyContinue'
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function New-EXOSafeAttachmentRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $SafeAttachmentRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $SafeAttachmentRuleParams -Operation 'New' )
        Write-Verbose "Creating New SafeAttachmentRule $($BuiltParams.Name) with values: $($BuiltParams | Out-String)"
        New-SafeAttachmentRule @BuiltParams -Confirm:$false
        $VerbosePreference = 'SilentlyContinue'
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function New-EXOSafeLinksRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $SafeLinksRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $SafeLinksRuleParams -Operation 'New' )
        Write-Verbose "Creating New SafeLinksRule $($BuiltParams.Name) with values: $($BuiltParams | Out-String)"
        New-SafeLinksRule @BuiltParams -Confirm:$false
        $VerbosePreference = 'SilentlyContinue'
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Set-EXOAntiPhishRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $AntiPhishRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $AntiPhishRuleParams -Operation 'Set' )
        if ($BuiltParams.keys -gt 1)
        {
            Write-Verbose "Setting AntiPhishRule $($BuiltParams.Identity) with values: $($BuiltParams | Out-String)"
            Set-AntiPhishRule @BuiltParams -Confirm:$false
            $VerbosePreference = 'SilentlyContinue'
        }
        else
        {
            Write-Verbose "No more values to Set on AntiPhishRule $($BuiltParams.Identity) using supplied values: $($BuiltParams | Out-String)"
            $VerbosePreference = 'SilentlyContinue'
        }
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Set-EXOAntiPhishPolicy
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $AntiPhishPolicyParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $AntiPhishPolicyParams -Operation 'Set' )
        if ($BuiltParams.keys -gt 1)
        {
            Write-Verbose "Setting AntiPhishPolicy $($BuiltParams.Identity) with values: $($BuiltParams | Out-String)"
            Set-AntiPhishPolicy @BuiltParams -Confirm:$false
            $VerbosePreference = 'SilentlyContinue'
        }
        else
        {
            Write-Verbose "No more values to Set on AntiPhishPolicy $($BuiltParams.Identity) using supplied values: $($BuiltParams | Out-String)"
            $VerbosePreference = 'SilentlyContinue'
        }
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Set-EXOHostedContentFilterRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $HostedContentFilterRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $HostedContentFilterRuleParams -Operation 'Set' )
        if ($BuiltParams.keys -gt 1)
        {
            Write-Verbose "Setting HostedContentFilterRule $($BuiltParams.Identity) with values: $($BuiltParams | Out-String)"
            Set-HostedContentFilterRule @BuiltParams -Confirm:$false
            $VerbosePreference = 'SilentlyContinue'
        }
        else
        {
            Write-Verbose "No more values to Set on HostedContentFilterRule $($BuiltParams.Identity) using supplied values: $($BuiltParams | Out-String)"
            $VerbosePreference = 'SilentlyContinue'
        }
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Set-EXOSafeAttachmentRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $SafeAttachmentRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $SafeAttachmentRuleParams -Operation 'Set' )
        if ($BuiltParams.keys -gt 1)
        {
            Write-Verbose "Setting SafeAttachmentRule $($BuiltParams.Identity) with values: $($BuiltParams | Out-String)"
            Set-SafeAttachmentRule @BuiltParams -Confirm:$false
            $VerbosePreference = 'SilentlyContinue'
        }
        else
        {
            Write-Verbose "No more values to Set on SafeAttachmentRule $($BuiltParams.Identity) using supplied values: $($BuiltParams | Out-String)"
            $VerbosePreference = 'SilentlyContinue'
        }
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Set-EXOSafeLinksRule
{
    param (
        [Parameter()]
        [System.Collections.Hashtable]
        $SafeLinksRuleParams
    )
    try
    {
        $VerbosePreference = 'Continue'
        $BuiltParams = (Format-EXOParams -InputEXOParams $SafeLinksRuleParams -Operation 'Set' )
        if ($BuiltParams.keys -gt 1)
        {
            Write-Verbose "Setting SafeLinksRule $($BuiltParams.Identity) with values: $($BuiltParams | Out-String)"
            Set-SafeLinksRule @BuiltParams -Confirm:$false
            $VerbosePreference = 'SilentlyContinue'
        }
        else
        {
            Write-Verbose "No more values to Set on SafeLinksRule $($BuiltParams.Identity) using supplied values: $($BuiltParams | Out-String)"
            $VerbosePreference = 'SilentlyContinue'
        }
    }
    catch
    {
        Close-SessionsAndReturnError -ExceptionMessage $_.Exception
    }
}

function Test-SPOServiceConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $SPOCentralAdminUrl,

        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "SilentlyContinue"
    Write-Verbose "Verifying the LCM connection state to SharePoint Online"
    $catch = Connect-SPOService -Url $SPOCentralAdminUrl -Credential $GlobalAdminAccount
}

function Test-PnPOnlineConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $SiteUrl,

        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "SilentlyContinue"
    Write-Verbose "Verifying the LCM connection state to SharePoint Online with PnP"
    $catch = Connect-PnPOnline -Url $SiteUrl -Credentials $GlobalAdminAccount
}

function Test-O365ServiceConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "SilentlyContinue"
    Write-Verbose "Verifying the LCM connection state to Microsoft Azure Active Directory Services"
    $catch = Connect-AzureAD -Credential $GlobalAdminAccount
}

function Test-TeamsServiceConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "SilentlyContinue"
    Import-Module MicrosoftTeams -Force
    Write-Verbose "Verifying the LCM connection state to Teams"
    $catch = Connect-MicrosoftTeams -Credential $GlobalAdminAccount | Out-Null
}


function Test-Office365DSCParameterState
{
    [CmdletBinding()]
    param
    (
        [Parameter(Mandatory = $true, Position = 1)]
        [HashTable]
        $CurrentValues,

        [Parameter(Mandatory = $true, Position = 2)]
        [Object]
        $DesiredValues,

        [Parameter(, Position = 3)]
        [Array]
        $ValuesToCheck
    )
    $VerbosePreference = 'SilentlyContinue'
    $WarningPreference = "SilentlyContinue"
    $returnValue = $true

    if (($DesiredValues.GetType().Name -ne "HashTable") `
            -and ($DesiredValues.GetType().Name -ne "CimInstance") `
            -and ($DesiredValues.GetType().Name -ne "PSBoundParametersDictionary"))
    {
        throw ("Property 'DesiredValues' in Test-SPDscParameterState must be either a " + `
                "Hashtable or CimInstance. Type detected was $($DesiredValues.GetType().Name)")
    }

    if (($DesiredValues.GetType().Name -eq "CimInstance") -and ($null -eq $ValuesToCheck))
    {
        throw ("If 'DesiredValues' is a CimInstance then property 'ValuesToCheck' must contain " + `
                "a value")
    }

    if (($null -eq $ValuesToCheck) -or ($ValuesToCheck.Count -lt 1))
    {
        $KeyList = $DesiredValues.Keys
    }
    else
    {
        $KeyList = $ValuesToCheck
    }

    $KeyList | ForEach-Object -Process {
        if (($_ -ne "Verbose") -and ($_ -ne "InstallAccount"))
        {
            if (($CurrentValues.ContainsKey($_) -eq $false) `
                    -or ($CurrentValues.$_ -ne $DesiredValues.$_) `
                    -or (($DesiredValues.ContainsKey($_) -eq $true) -and ($null -ne $DesiredValues.$_ -and $DesiredValues.$_.GetType().IsArray)))
            {
                if ($DesiredValues.GetType().Name -eq "HashTable" -or `
                        $DesiredValues.GetType().Name -eq "PSBoundParametersDictionary")
                {
                    $CheckDesiredValue = $DesiredValues.ContainsKey($_)
                }
                else
                {
                    $CheckDesiredValue = Test-SPDSCObjectHasProperty -Object $DesiredValues -PropertyName $_
                }

                if ($CheckDesiredValue)
                {
                    $desiredType = $DesiredValues.$_.GetType()
                    $fieldName = $_
                    if ($desiredType.IsArray -eq $true)
                    {
                        if (($CurrentValues.ContainsKey($fieldName) -eq $false) `
                                -or ($null -eq $CurrentValues.$fieldName))
                        {
                            Write-Verbose -Message ("Expected to find an array value for " + `
                                    "property $fieldName in the current " + `
                                    "values, but it was either not present or " + `
                                    "was null. This has caused the test method " + `
                                    "to return false.")
                            $returnValue = $false
                        }
                        else
                        {
                            $arrayCompare = Compare-Object -ReferenceObject $CurrentValues.$fieldName `
                                -DifferenceObject $DesiredValues.$fieldName
                            if ($null -ne $arrayCompare)
                            {
                                Write-Verbose -Message ("Found an array for property $fieldName " + `
                                        "in the current values, but this array " + `
                                        "does not match the desired state. " + `
                                        "Details of the changes are below.")
                                $arrayCompare | ForEach-Object -Process {
                                    Write-Verbose -Message "$($_.InputObject) - $($_.SideIndicator)"
                                }
                                $returnValue = $false
                            }
                        }
                    }
                    else
                    {
                        switch ($desiredType.Name)
                        {
                            "String"
                            {
                                if ([string]::IsNullOrEmpty($CurrentValues.$fieldName) `
                                        -and [string]::IsNullOrEmpty($DesiredValues.$fieldName))
                                {
                                }
                                else
                                {
                                    Write-Verbose -Message ("String value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Int32"
                            {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {
                                }
                                else
                                {
                                    Write-Verbose -Message ("Int32 value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Int16"
                            {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {
                                }
                                else
                                {
                                    Write-Verbose -Message ("Int16 value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Boolean"
                            {
                                if ($CurrentValues.$fieldName -ne $DesiredValues.$fieldName)
                                {
                                    Write-Verbose -Message ("Boolean value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Single"
                            {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {
                                }
                                else
                                {
                                    Write-Verbose -Message ("Single value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            default
                            {
                                Write-Verbose -Message ("Unable to compare property $fieldName " + `
                                        "as the type ($($desiredType.Name)) is " + `
                                        "not handled by the " + `
                                        "Test-SPDscParameterState cmdlet")
                                $returnValue = $false
                            }
                        }
                    }
                }
            }
        }
    }
    return $returnValue
}

function Get-UsersLicences
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param(
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount
    )
    Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount
    Write-Verbose "Store all users licences information in Global Variable for futur usage."
    #Store information to be able to check later if the users is correctly licences for features.
    if ($null -eq $Global:UsersLicences)
    {
        $Global:UsersLicences = Get-MsolUser -All | Select-Object UserPrincipalName, isLicensed, Licenses
    }
    Return $Global:UsersLicences
}

<# This is the main Office365DSC.Reverse function that extracts the DSC configuration from an existing
   Office 365 Tenant. #>
function Export-O365Configuration
{
    Show-O365GUI
}
function Start-O365ConfigurationExtract
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param(
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount,

        [Parameter()]
        [System.String[]]
        $ComponentsToExtract
    )
    $InformationPreference = "Continue"
    $VerbosePreference = "SilentlyContinue"
    $WarningPreference = "SilentlyContinue"
    $AzureAutomation = $false
    $DSCContent = "Configuration O365TenantConfig `r`n{`r`n"
    $DSCContent += "    Import-DSCResource -ModuleName Office365DSC`r`n`r`n"
    $DSCContent += "    <# Credentials #>`r`n"
    $DSCContent += "    Node localhost`r`n"
    $DSCContent += "    {`r`n"

    # Obtain central administration url from a User Principal Name
    $centralAdminUrl = $null
    Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount
    $users = Get-AzureADUser
    if ($users.Count -gt 0)
    {
        $tenantParts = $users[0].UserPrincipalName.Split('@')
        if ($tenantParts.Length -gt 0)
        {
            $tenantName = $tenantParts[1].Split(".")[0]
            $centralAdminUrl = "https://" + $tenantName + "-admin.sharepoint.com"
        }
    }

    # Add the GlobalAdminAccount to the Credentials List
    Save-Credentials -UserName $GlobalAdminAccount.UserName

    #region "O365AdminAuditLogConfig"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckO365AdminAuditLogConfig"))
    {
        Write-Information "Extracting O365AdminAuditLogConfig..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $O365AdminAuditLogConfig = Get-AdminAuditLogConfig

        $O365AdminAuditLogConfigModulePath = Join-Path -Path $PSScriptRoot `
                                                       -ChildPath "..\DSCResources\MSFT_O365AdminAuditLogConfig\MSFT_O365AdminAuditLogConfig.psm1" `
                                                       -Resolve

        $value = "Disabled"
        if ($O365AdminAuditLogConfig.UnifiedAuditLogIngestionEnabled)
        {
            $value = "Enabled"
        }

        Import-Module $O365AdminAuditLogConfigModulePath | Out-Null
        $DSCContent += Export-TargetResource -UnifiedAuditLogIngestionEnabled $value -GlobalAdminAccount $GlobalAdminAccount -IsSingleInstance 'Yes'
    }
    #endregion

    #region "EXOAtpPolicyForO365"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOAtpPolicyForO365"))
    {
        Write-Information "Extracting EXOAtpPolicyForO365..."
        $EXOAtpPolicyForO365ModulePath = Join-Path -Path $PSScriptRoot `
                                                -ChildPath "..\DSCResources\MSFT_EXOAtpPolicyForO365\MSFT_EXOAtpPolicyForO365.psm1" `
                                                -Resolve

        Import-Module $EXOAtpPolicyForO365ModulePath | Out-Null
        $DSCContent += Export-TargetResource -IsSingleInstance "Yes" -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    #region "EXOCASMailboxPlan"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOCASMailboxPlan"))
    {
        Write-Information "Extracting EXOCASMailboxPlan..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $CASMailboxPlans = Get-CASMailboxPlan
        $EXOCASMailboxPlanModulePath = Join-Path -Path $PSScriptRoot `
                                                -ChildPath "..\DSCResources\MSFT_EXOCASMailboxPlan\MSFT_EXOCASMailboxPlan.psm1" `
                                                -Resolve

        Import-Module $EXOCASMailboxPlanModulePath | Out-Null

        foreach ($CASMailboxPlan in $CASMailboxPlans)
        {
            $DSCContent += Export-TargetResource -Identity $CASMailboxPlan.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOClientAccessRule"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOClientAccessRule"))
    {
        Write-Information "Extracting EXOClientAccessRule..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $ClientAccessRules = Get-ClientAccessRule
        $EXOClientAccessRuleModulePath = Join-Path -Path $PSScriptRoot `
                                                -ChildPath "..\DSCResources\MSFT_EXOClientAccessRule\MSFT_EXOClientAccessRule.psm1" `
                                                -Resolve

        Import-Module $EXOClientAccessRuleModulePath | Out-Null
        foreach ($ClientAccessRule in $ClientAccessRules)
        {
            $DSCContent += Export-TargetResource -Identity $ClientAccessRule.Identity -Action $ClientAccessRule.Action -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXODkimSigningConfig"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXODkimSigningConfig"))
    {
        Write-Information "Extracting EXODkimSigningConfig..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $DkimSigningConfigs = Get-DkimSigningConfig
        $EXODkimSigningConfigModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXODkimSigningConfig\MSFT_EXODkimSigningConfig.psm1" `
                                                    -Resolve

        Import-Module $EXODkimSigningConfigModulePath | Out-Null
        foreach ($DkimSigningConfig in $DkimSigningConfigs)
        {
            Write-Verbose "    {$($DkimSigningConfig.Identity)}"
            $DSCContent += Export-TargetResource -Identity $DkimSigningConfig.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOHostedConnectionFilterPolicy"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOHostedConnectionFilterPolicy"))
    {
        Write-Information "Extracting EXOHostedConnectionFilterPolicy..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $HostedConnectionFilterPolicys = Get-HostedConnectionFilterPolicy
        $EXOHostedConnectionFilterPolicyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOHostedConnectionFilterPolicy\MSFT_EXOHostedConnectionFilterPolicy.psm1" `
                                                    -Resolve

        Import-Module $EXOHostedConnectionFilterPolicyModulePath | Out-Null
        foreach ($HostedConnectionFilterPolicy in $HostedConnectionFilterPolicys)
        {
            $DSCContent += Export-TargetResource -Identity $HostedConnectionFilterPolicy.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOHostedContentFilterPolicy"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOHostedContentFilterPolicy"))
    {
        Write-Information "Extracting EXOHostedContentFilterPolicy..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $HostedContentFilterPolicies = Get-HostedContentFilterPolicy
        $EXOHostedContentFilterPolicyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOHostedContentFilterPolicy\MSFT_EXOHostedContentFilterPolicy.psm1" `
                                                    -Resolve

        Import-Module $EXOHostedContentFilterPolicyModulePath | Out-Null
        foreach ($HostedContentFilterPolicy in $HostedContentFilterPolicies)
        {
            $DSCContent += Export-TargetResource -Identity $HostedContentFilterPolicy.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOHostedContentFilterRule"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOHostedContentFilterRule"))
    {
        Write-Information "Extracting EXOHostedContentFilterRule..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $HostedContentFilterRules = Get-HostedContentFilterRule
        $EXOHostedContentFilterRuleModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOHostedContentFilterRule\MSFT_EXOHostedContentFilterRule.psm1" `
                                                    -Resolve

        Import-Module $EXOHostedContentFilterRuleModulePath | Out-Null
        foreach ($HostedContentFilterRule in $HostedContentFilterRules)
        {
            $DSCContent += Export-TargetResource -Identity $HostedContentFilterRule.Identity -HostedContentFilterPolicy $HostedContentFilterRule.HostedContentFilterPolicy -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOHostedOutboundSpamFilterPolicy"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOHostedOutboundSpamFilterPolicy"))
    {
        Write-Information "Extracting EXOHostedOutboundSpamFilterPolicy..."
        $EXOHostedOutboundSpamFilterPolicyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOHostedOutboundSpamFilterPolicy\MSFT_EXOHostedOutboundSpamFilterPolicy.psm1" `
                                                    -Resolve

        Import-Module $EXOHostedOutboundSpamFilterPolicyModulePath | Out-Null
        $DSCContent += Export-TargetResource -IsSingleInstance "Yes" -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    #region "EXOSafeAttachmentPolicy"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOSafeAttachmentPolicy"))
    {
        Write-Information "Extracting EXOSafeAttachmentPolicy..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $SafeAttachmentPolicies = Get-SafeAttachmentPolicy
        $EXOSafeAttachmentPolicyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOSafeAttachmentPolicy\MSFT_EXOSafeAttachmentPolicy.psm1" `
                                                    -Resolve

        Import-Module $EXOSafeAttachmentPolicyModulePath | Out-Null
        foreach ($SafeAttachmentPolicy in $SafeAttachmentPolicies)
        {
            $DSCContent += Export-TargetResource -Identity $SafeAttachmentPolicy.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOSafeAttachmentRule"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOSafeAttachmentRule"))
    {
        Write-Information "Extracting EXOSafeAttachmentRule..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $SafeAttachmentRules = Get-SafeAttachmentRule
        $EXOSafeAttachmentRuleModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOSafeAttachmentRule\MSFT_EXOSafeAttachmentRule.psm1" `
                                                    -Resolve

        Import-Module $EXOSafeAttachmentRuleModulePath | Out-Null
        foreach ($SafeAttachmentRule in $SafeAttachmentRules)
        {
            $DSCContent += Export-TargetResource -Identity $SafeAttachmentRule.Identity -SafeAttachmentPolicy $SafeAttachmentRule.SafeAttachmentPolicy -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOSafeLinksPolicy"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOSafeLinksPolicy"))
    {
        Write-Information "Extracting EXOSafeLinksPolicy..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $SafeLinksPolicies = Get-SafeLinksPolicy
        $EXOSafeLinksPolicyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOSafeLinksPolicy\MSFT_EXOSafeLinksPolicy.psm1" `
                                                    -Resolve

        Import-Module $EXOSafeLinksPolicyModulePath | Out-Null
        foreach($SafeLinksPolicy in $SafeLinksPolicies)
        {
            $DSCContent += Export-TargetResource -Identity $SafeLinksPolicy.Identity -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOSafeLinksRule"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOSafeLinksRule"))
    {
        Write-Information "Extracting EXOSafeLinksRule..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $SafeLinksRules = Get-SafeLinksRule
        $EXOSafeLinksRuleModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_EXOSafeLinksRule\MSFT_EXOSafeLinksRule.psm1" `
                                                    -Resolve

        Import-Module $EXOSafeLinksRuleModulePath | Out-Null
        foreach ($SafeLinksRule in $SafeLinksRules)
        {
            $DSCContent += Export-TargetResource -Identity $SafeLinksRule.Identity -SafeLinksPolicy $SafeLinksRule.SafeLinksPolicy -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOMailboxSettings"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOMailboxSettings"))
    {
        Write-Information "Extracting EXOMailboxSettings..."
        $EXOMailboxSettingsModulePath = Join-Path -Path $PSScriptRoot `
                                                  -ChildPath "..\DSCResources\MSFT_EXOMailboxSettings\MSFT_EXOMailboxSettings.psm1" `
                                                  -Resolve

        Import-Module $EXOMailboxSettingsModulePath | Out-Null
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $mailboxes = Get-Mailbox

        foreach ($mailbox in $mailboxes)
        {
            Write-Information "    Settings for Mailbox {$($mailbox.Name)}"
            $mailboxName = $mailbox.Name
            if ($mailboxName)
            {
                $DSCContent += Export-TargetResource -DisplayName $mailboxName -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region "EXOMailTips"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOMailTips"))
    {
        Write-Information "Extracting EXOMailTips..."
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $OrgConfig = Get-OrganizationConfig

        $organizationName = $OrgConfig.Name
        Add-ConfigurationDataEntry -Node "localhost" `
                                   -Key "OrganizationName" `
                                   -Value $organizationName `
                                   -Description "Name of the Organization"

        $EXOMailTipsModulePath = Join-Path -Path $PSScriptRoot `
                                           -ChildPath "..\DSCResources\MSFT_EXOMailTips\MSFT_EXOMailTips.psm1" `
                                           -Resolve

        Import-Module $EXOMailTipsModulePath | Out-Null
        $DSCContent += Export-TargetResource -Organization $organizationName -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    #region "EXOSharedMailbox"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckEXOSharedMailbox"))
    {
        $EXOSharedMailboxModulePath = Join-Path -Path $PSScriptRoot `
                                                -ChildPath "..\DSCResources\MSFT_EXOSharedMailbox\MSFT_EXOSharedMailbox.psm1" `
                                                -Resolve

        Import-Module $EXOSharedMailboxModulePath | Out-Null
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $mailboxes = Get-Mailbox
        $mailboxes = $mailboxes | Where-Object {$_.RecipientTypeDetails -eq "SharedMailbox"}

        foreach ($mailbox in $mailboxes)
        {
            Write-Information "    MailTips for mailbox {$($mailbox.Name)}"
            $mailboxName = $mailbox.Name
            if ($mailboxName)
            {
                $DSCContent += Export-TargetResource -DisplayName $mailboxName -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region "O365Group"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckO365Group"))
    {
        Write-Information "Extracting O365Group..."
        $O365GroupModulePath = Join-Path -Path $PSScriptRoot `
                                         -ChildPath "..\DSCResources\MSFT_O365Group\MSFT_O365Group.psm1" `
                                         -Resolve

        Import-Module $O365GroupModulePath | Out-Null

        # Security Groups
        Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount
        $securityGroups = Get-AzureAdGroup | Where-Object {$_.SecurityEnabled -eq $true}

        foreach ($securityGroup in $securityGroups)
        {
            Write-Information "    Security Group {$($securityGroup.DisplayName)}"
            $securityGroupDisplayName = $securityGroup.DisplayName
            if ($securityGroupDisplayName)
            {
                $DSCContent += Export-TargetResource -DisplayName $securityGroupDisplayName `
                                                    -GroupType "Security" `
                                                    -GlobalAdminAccount $GlobalAdminAccount
            }
        }

        $securityGroups = Get-AzureAdGroup | Where-Object {$_.SecurityEnabled -eq $true}

        # Other Groups
        Connect-ExchangeOnline -GlobalAdminAccount $GlobalAdminAccount
        $groups = Get-Group

        $groups = $groups | Where-Object { `
            $_.RecipientType -eq "MailUniversalDistributionGroup" `
            -or $_.RecipientType -eq "MailUniversalSecurityGroup" `
        }
        foreach ($group in $groups)
        {
            $groupName = $group.DisplayName
            if ($groupName)
            {
                $groupType = "DistributionList"
                if ($group.RecipientTypeDetails -eq "GroupMailbox")
                {
                    $groupType = "Office365"
                }
                elseif ($group.RecipientTypeDetails -eq "MailUniversalSecurityGroup")
                {
                    $groupType = "MailEnabledSecurity"
                }
                Write-Information "    $($groupType) Group {$($groupName)}"
                $DSCContent += Export-TargetResource -DisplayName $groupName `
                                                    -GroupType $groupType `
                                                    -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region "O365User"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckO365User"))
    {
        Write-Information "Extracting O365User..."
        $O365UserModulePath = Join-Path -Path $PSScriptRoot `
                                        -ChildPath "..\DSCResources\MSFT_O365USer\MSFT_O365USer.psm1" `
                                        -Resolve

        Import-Module $O365UserModulePath | Out-Null
        Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount

        $users = Get-AzureADUser

        foreach ($user in $users)
        {
            Write-Information "    User {$($user.UserPrincipalName)}"
            $userUPN = $user.UserPrincipalName
            if ($userUPN)
            {
                $DSCContent += Export-TargetResource -UserPrincipalName $userUPN -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region "ODSettings"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckODSettings"))
    {
        Write-Information "Extracting ODSettings..."
        $ODSettingsModulePath = Join-Path -Path $PSScriptRoot `
                                        -ChildPath "..\DSCResources\MSFT_ODSettings\MSFT_ODSettings.psm1" `
                                        -Resolve

        Import-Module $ODSettingsModulePath | Out-Null

        if ($centralAdminUrl)
        {
            $DSCContent += Export-TargetResource -CentralAdminUrl $centralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "SPOSearchResultSource"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSearchResultSource"))
    {
        $InfoMapping = @(
        @{
            Protocol    = "Local"
            Type        = "SharePoint"
            ProviderID  = "fa947043-6046-4f97-9714-40d4c113963d"
        },
        @{
            Protocol    = "Remote"
            Type        = "SharePoint"
            ProviderID  = "1e0c8601-2e5d-4ccb-9561-53743b5dbde7"
        },
        @{
            Protocol    = "Exchange"
            Type        = "SharePoint"
            ProviderID  = "3a17e140-1574-4093-bad6-e19cdf1c0122"
        },
        @{
            Protocol    = "OpenSearch"
            Type        = "SharePoint"
            ProviderID  = "3a17e140-1574-4093-bad6-e19cdf1c0121"
        },
        @{
            Protocol   = "Local"
            Type       = "People"
            ProviderID = "e4bcc058-f133-4425-8ffc-1d70596ffd33"
        },
        @{
            Protocol   = "Remote"
            Type       = "People"
            ProviderID = "e377caaa-fcaf-4a1b-b7a1-e69a506a07aa"
        }
        )
        Write-Information "Extracting SPOSearchResultSource..."
        $SPOSearchResultSourceModulePath = Join-Path -Path $PSScriptRoot `
                                                        -ChildPath "..\DSCResources\MSFT_SPOSearchResultSource\MSFT_SPOSearchResultSource.psm1" `
                                                        -Resolve

        Import-Module $SPOSearchResultSourceModulePath | Out-Null
        Test-PnPOnlineConnection -SiteUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
        $SearchConfig = [Xml] (Get-PnPSearchConfiguration -Scope Subscription)
        $sources =  $SearchConfig.SearchConfigurationSettings.SearchQueryConfigurationSettings.SearchQueryConfigurationSettings.Sources.Source
        foreach ($source in $sources)
        {
            $mapping = $InfoMapping | Where-Object { $_.ProviderID -eq $source.ProviderId }
            Write-Information "    Result Source {$($source.Name)}"
            $DSCContent += Export-TargetResource -Name $source.Name `
                                                -Protocol $mapping.Protocol `
                                                -CentralAdminUrl $centralAdminUrl `
                                                -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "SPOSearchManagedProperty"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSearchManagedProperty"))
    {
        Write-Information "Extracting SPOSearchManagedProperty..."
        $SPOSearchManagedPropertyModulePath = Join-Path -Path $PSScriptRoot `
                                                        -ChildPath "..\DSCResources\MSFT_SPOSearchManagedProperty\MSFT_SPOSearchManagedProperty.psm1" `
                                                        -Resolve

        Import-Module $SPOSearchManagedPropertyModulePath | Out-Null
        Test-PnPOnlineConnection -SiteUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
        $SearchConfig = [Xml] (Get-PnPSearchConfiguration -Scope Subscription)
        $properties =  $SearchConfig.SearchConfigurationSettings.SearchSchemaConfigurationSettings.ManagedProperties.dictionary.KeyValueOfstringManagedPropertyInfoy6h3NzC8

        foreach ($property in $properties)
        {
            Write-Information "    Managed Property {$($property.Value.Name)}"
            $DSCContent += Export-TargetResource -Name $property.Value.Name `
                                                -Type $property.Value.ManagedType `
                                                -CentralAdminUrl $centralAdminUrl `
                                                -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSiteDesign"))
    {
        Write-Information "Extracting SPOSiteDesign..."
        $SPOSiteDesignModulePath = Join-Path -Path $PSScriptRoot `
                                                        -ChildPath "..\DSCResources\MSFT_SPOSiteDesign\MSFT_SPOSiteDesign.psm1" `
                                                        -Resolve

        $catch = Import-Module $SPOSiteDesignModulePath
        Test-PnPOnlineConnection -SiteUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
        $siteDesigns = Get-PnPSiteDesign

        foreach ($siteDesign in $siteDesigns)
        {
            Write-Information "    Site Design {$($siteDesign.Title)}"
            $DSCContent += Export-TargetResource -Title $siteDesign.Title `
                                                -CentralAdminUrl $centralAdminUrl `
                                                -GlobalAdminAccount $GlobalAdminAccount
        }
    }

    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSiteDesignRights"))
    {
        Write-Information "Extracting SPOSiteDesignRights..."
        $SPOSiteDesignModulePath = Join-Path -Path $PSScriptRoot `
                                                        -ChildPath "..\DSCResources\MSFT_SPOSiteDesignRights\MSFT_SPOSiteDesignRights.psm1" `
                                                        -Resolve

        $catch = Import-Module $SPOSiteDesignModulePath
        Test-PnPOnlineConnection -SiteUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount

        $siteDesigns = Get-PnPSiteDesign

        foreach ($siteDesign in $siteDesigns)
        {
            $siteDesignRight = Get-PnPSiteDesignRights -Identity $siteDesign.Id
            Write-Information "    Site Design Rights {$($siteDesign.Id)}"
            $DSCContent += Export-TargetResource -Title $siteDesign.Title `
                                                -CentralAdminUrl $centralAdminUrl `
                                                -GlobalAdminAccount $GlobalAdminAccount
        }
    }

    #region "SPOSite"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSite"))
    {
        Write-Information "Extracting SPOSite..."
        $SPOSiteModulePath = Join-Path -Path $PSScriptRoot `
                                        -ChildPath "..\DSCResources\MSFT_SPOSite\MSFT_SPOSite.psm1" `
                                        -Resolve

        Import-Module $SPOSiteModulePath | Out-Null

        Test-SPOServiceConnection -SPOCentralAdminUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
        $sites = Get-SPOSite

        foreach ($site in $sites)
        {
            Write-Information "    Site Collection {$($site.Url)}"
            $DSCContent += Export-TargetResource -Url $site.Url `
                                                -CentralAdminUrl $centralAdminUrl `
                                                -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    Test-TeamsServiceConnection -GlobalAdminAccount $GlobalAdminAccount
    $Teams = Get-Team

    #region "TeamsTeam"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamsTeam"))
    {
        Write-Information "Extracting TeamsTeam..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_TeamsTeam\MSFT_TeamsTeam.psm1" `
                                    -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $teams)
        {
            Write-Information "    Team {$($team.DisplayName)}"
            $DSCContent += Export-TargetResource -DisplayName $team.DisplayName `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "TeamsChannel"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamsChannel"))
    {
        Write-Information "Extracting TeamsChannel..."
        $TeamsChannelModulePath = Join-Path -Path $PSScriptRoot `
                                        -ChildPath "..\DSCResources\MSFT_TeamsChannel\MSFT_TeamsChannel.psm1" `
                                        -Resolve

        Import-Module $TeamsChannelModulePath | Out-Null

        foreach ($team in $Teams)
        {
            $channels = Get-TeamChannel -GroupId $team.GroupId

            foreach ($channel in $channels)
            {
                Write-Information "    Team Channel {$($channel.DisplayName)}"
                $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                     -DisplayName $channel.DisplayName `
                                                     -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region "TeamsFunSettings"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamsFunSettings"))
    {
        Write-Information "Extracting TeamsFunSettings..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_TeamsFunSettings\MSFT_TeamsFunSettings.psm1" `
                                    -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $Teams)
        {
            Write-Information "    Team Fun Settings for Team {$($team.DisplayName)}"
            $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "TeamsUser"
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamsUser"))
    {
        Write-Information "Extracting TeamsUser..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                        -ChildPath "..\DSCResources\MSFT_TeamsUser\MSFT_TeamsUser.psm1" `
                                        -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $Teams)
        {
            $users = Get-TeamUser -GroupId $team.GroupId
            foreach ($user in $users)
            {
                Write-Information "    Teams User {$($user.User)}"
                $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                     -User $user.User `
                                                     -Role $user.Role `
                                                     -GlobalAdminAccount $GlobalAdminAccount
            }
        }
    }
    #endregion

    #region TeamsMemberSettings
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamMemberSettings"))
    {
        Write-Information "Extracting TeamsMemberSettings..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_TeamsMemberSettings\MSFT_TeamsMemberSettings.psm1" `
                                    -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $Teams)
        {
            Write-Information "    Team Member Settings for Team {$($team.DisplayName)}"
            $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region TeamsMessageSettings
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckSPOSearchManagedProperty"))
    {
        Write-Information "Extracting TeamsMessageSettings..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_TeamsMessageSettings\MSFT_TeamsMessageSettings.psm1" `
                                    -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $Teams)
        {
            Write-Information "    Team Member Settings for Team {$($team.DisplayName)}"
            $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region TeamsGuestSettings
    if ($null -ne $ComponentsToExtract -and $ComponentsToExtract.Contains("chckTeamsGuestSettings"))
    {
        Write-Information "Extracting TeamsGuestSettings..."
        $TeamsModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_TeamsGuestSettings\MSFT_TeamsGuestSettings.psm1" `
                                    -Resolve

        Import-Module $TeamsModulePath | Out-Null

        foreach ($team in $Teams)
        {
            Write-Information "    Team Member Settings for Team {$($team.DisplayName)}"
            $DSCContent += Export-TargetResource -TeamName $team.DisplayName `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    # Close the Node and Configuration declarations
    $DSCContent += "    }`r`n"
    $DSCContent += "}`r`n"

    #region Add the Prompt for Required Credentials at the top of the Configuration
    $credsContent = ""
    foreach ($credential in $Global:CredsRepo)
    {
        if (!$credential.ToLower().StartsWith("builtin"))
        {
            if (!$AzureAutomation)
            {
                $credsContent += "    " + (Resolve-Credentials $credential) + " = Get-Credential -UserName `"" + $credential + "`" -Message `"Please provide credentials`"`r`n"
            }
            else
            {
                $resolvedName = (Resolve-Credentials $credential)
                $credsContent += "    " + $resolvedName + " = Get-AutomationPSCredential -Name " + ($resolvedName.Replace("$", "")) + "`r`n"
            }
        }
    }
    $credsContent += "`r`n"
    $startPosition = $DSCContent.IndexOf("<# Credentials #>") + 19
    $DSCContent = $DSCContent.Insert($startPosition, $credsContent)
    $DSCContent += "O365TenantConfig -ConfigurationData .\ConfigurationData.psd1"
    #endregion

    #region Prompt the user for a location to save the extract and generate the files
    $OutputDSCPath = Read-Host "Destination Path"
    while (!(Test-Path -Path $OutputDSCPath -PathType Container -ErrorAction SilentlyContinue))
    {
        try
        {
            Write-Information "Directory `"$OutputDSCPath`" doesn't exist; creating..."
            New-Item -Path $OutputDSCPath -ItemType Directory | Out-Null
            if ($?) {break}
        }
        catch
        {
            Write-Warning "$($_.Exception.Message)"
            Write-Warning "Could not create folder $OutputDSCPath!"
        }
        $OutputDSCPath = Read-Host "Please Provide Output Folder for DSC Configuration (Will be Created as Necessary)"
    }
    <## Ensures the path we specify ends with a Slash, in order to make sure the resulting file path is properly structured. #>
    if (!$OutputDSCPath.EndsWith("\") -and !$OutputDSCPath.EndsWith("/"))
    {
        $OutputDSCPath += "\"
    }

    $outputDSCFile = $OutputDSCPath + "Office365TenantConfig.ps1"
    $DSCContent | Out-File $outputDSCFile

    if (!$AzureAutomation)
    {
        $outputConfigurationData = $OutputDSCPath + "ConfigurationData.psd1"
        New-ConfigurationDataDocument -Path $outputConfigurationData
    }
    #endregion
    Invoke-Item -Path $OutputDSCPath
}
